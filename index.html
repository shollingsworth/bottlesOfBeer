<!DOCTYPE html>
<html lang="en">
<head> 
<meta charset="utf-8">
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<title></title>
</head>
<body>
</body>
</html>
<script type="text/javascript">
$(document).ready(function(){ init(); });
var body = $('body');
var Bottles = {
   'bottleType':'Beer',
   'bottleCount':'100',
   'tempoDuration':600,
   'tempoSpeed':1,
   'tempoBlock':[
      '{{cnt}}',
      'Bottles of',
      '{{type}} on the',
      'wall',
      '{{cnt}}',
      'Bottles of',
      '{{type}}',
      '',
      'Take',
      'one down',
      'pass it',
      'around'
   ],
   'lastBlock':[
      '',
      'no more',
      'Bottles of',
      '{{type}} on the',
      'wall!'
   ]
};

function getStanza(cnt,type) {
   var replace = {};
   replace.type = type;
   replace.cnt = cnt;
   var retarr = [];
   var block;
   if(cnt === 0) {
      block = Bottles.lastBlock;
   } else {
      block = Bottles.tempoBlock;
   }
   $.each(block,function(i,line){
      var re = /\{\{(.*)\}\}/g;
      var arr = re.exec(line);
      if(arr !== null) {
         var repl = arr[1];
         line = line.replace(re,replace[repl],"$0");
      }
      retarr.push(line);
   });
   return retarr;
}

function getCurrentStatus(cnt,type) {
   return cnt+" Bottles of "+type+" on the wall";
}

function setQueue(cnt,type) {
   body.queue('Queue',[]).stop();
   var durationCounter = 0;
   var queue = [];
   while(cnt >= 0) {
      var stan = getStanza(cnt,type);
      var title = getCurrentStatus(cnt,type);
      queue.push({
         stanza:stan,
         title:title
      });
      cnt--;
   }

   $.each(queue,function(i,set){
      var stanza = set.stanza;
      var title = set.title;
      body.queue('Queue', function(){ 
         $('title').html(title);
         console.log('new title: '+title);
         $(this).dequeue('Queue');
      });
      $.each(stanza,function(z,line){
         body.queue('Queue', function(){ 
            console.log(line);
            $(this).dequeue('Queue');
         }).delay(Bottles.tempoDuration,'Queue');
      });
   });
   body.dequeue('Queue');
}

function init() {
   $('title').html(getCurrentStatus(Bottles.bottleCount,Bottles.bottleType));
   setQueue(Bottles.bottleCount,Bottles.bottleType);
}
</script>
